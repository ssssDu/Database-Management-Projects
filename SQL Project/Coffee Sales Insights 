/* Rank monthly sales of different products */
SELECT PRODCOFFEE.PRODNAME, extract(MONTH from FACTCOFFEE.FACTDATE), sum(FACTCOFFEE.ACTSALES) as sumsales
FROM PRODCOFFEE, FACTCOFFEE
WHERE PRODCOFFEE.PRODUCTID = FACTCOFFEE.PRODUCTID 
GROUP BY PRODCOFFEE.PRODNAME, extract(MONTH from FACTCOFFEE.FACTDATE)
ORDER BY sum(FACTCOFFEE.ACTSALES) DESC;

/* Find states that have the top selling coffee products in both Yr 2012 and 2013 */
CREATE TABLE TOPSALE2012 AS(
SELECT *
FROM(
SELECT PRODCOFFEE.PRODNAME,STATES.STATENAME, sum(FACTCOFFEE.ACTSALES) as sumsales, ROW_NUMBER() OVER(PARTITION BY STATES.STATENAME ORDER BY sum(FACTCOFFEE.ACTSALES) DESC) as myrank 
FROM PRODCOFFEE, FACTCOFFEE,AREACODE, STATES
WHERE PRODCOFFEE.PRODUCTID = FACTCOFFEE.PRODUCTID AND extract(year from FACTCOFFEE.FACTDATE) = 2012 AND FACTCOFFEE.AREAID = AREACODE.AREAID AND AREACODE.STATEID = STATES.STATEID
GROUP BY PRODCOFFEE.PRODNAME, extract(year from FACTCOFFEE.FACTDATE),STATES.STATENAME) X
WHERE X.myrank = 1);

CREATE TABLE TOPSALE2013 AS(
SELECT *
FROM(
SELECT PRODCOFFEE.PRODNAME,STATES.STATENAME, sum(FACTCOFFEE.ACTSALES) as sumsales, ROW_NUMBER() OVER(PARTITION BY STATES.STATENAME ORDER BY sum(FACTCOFFEE.ACTSALES) DESC) as myrank 
FROM PRODCOFFEE, FACTCOFFEE,AREACODE, STATES
WHERE PRODCOFFEE.PRODUCTID = FACTCOFFEE.PRODUCTID AND extract(year from FACTCOFFEE.FACTDATE) = 2013 AND FACTCOFFEE.AREAID = AREACODE.AREAID AND AREACODE.STATEID = STATES.STATEID
GROUP BY PRODCOFFEE.PRODNAME, extract(year from FACTCOFFEE.FACTDATE),STATES.STATENAME) X
WHERE X.myrank = 1);

SELECT TOPSALE2013.STATENAME
FROM TOPSALE2013
INNER JOIN TOPSALE2012 ON TOPSALE2012.STATENAME = TOPSALE2013.STATENAME;

/* Find the top 2 coffee products with highest sales in both Yr 2012 and 2013 */
SELECT A.PRODNAME,A.sumsales as sales2013,B.sumsales as sales2012
FROM(
SELECT PRODCOFFEE.PRODNAME,extract(year from FACTCOFFEE.FACTDATE),sum(FACTCOFFEE.ACTSALES) as sumsales, ROW_NUMBER() OVER(ORDER BY sum(FACTCOFFEE.ACTSALES) DESC) as myrank 
FROM PRODCOFFEE, FACTCOFFEE
WHERE PRODCOFFEE.PRODUCTID = FACTCOFFEE.PRODUCTID AND extract(year from FACTCOFFEE.FACTDATE) = 2013
GROUP BY PRODCOFFEE.PRODNAME, extract(year from FACTCOFFEE.FACTDATE)) A
INNER JOIN 
(SELECT PRODCOFFEE.PRODNAME,extract(year from FACTCOFFEE.FACTDATE),sum(FACTCOFFEE.ACTSALES) as sumsales, ROW_NUMBER() OVER(ORDER BY sum(FACTCOFFEE.ACTSALES) DESC) as myrank 
FROM PRODCOFFEE, FACTCOFFEE
WHERE PRODCOFFEE.PRODUCTID = FACTCOFFEE.PRODUCTID AND extract(year from FACTCOFFEE.FACTDATE) = 2012
GROUP BY PRODCOFFEE.PRODNAME, extract(year from FACTCOFFEE.FACTDATE)) B
ON A.PRODNAME = B.PRODNAME
WHERE A.myrank <=2 AND B.myrank <=2;

/* Find the percentage of coffee sales' profit within each states */
WITH Q4_2 AS(
SELECT STATES.STATENAME, sum(FACTCOFFEE.ACTPROFIT) as statesumprofit
FROM FACTCOFFEE,AREACODE, STATES
WHERE  FACTCOFFEE.AREAID = AREACODE.AREAID AND AREACODE.STATEID = STATES.STATEID
GROUP BY STATES.STATENAME),

Q4_2_2 AS(SELECT sum(Q4_2.statesumprofit) as sums
FROM Q4_2)

SELECT Q4_2.STATENAME, ROUND((Q4_2.statesumprofit / Q4_2_2.sums),2) as percent
FROM Q4_2,Q4_2_2
ORDER BY percent DESC;

/* Find the ranking of profit (hight to low) for different coffee products */
SELECT PRODCOFFEE.PRODNAME, sum(FACTCOFFEE.ACTPROFIT) as profit
FROM PRODCOFFEE, FACTCOFFEE
WHERE PRODCOFFEE.PRODUCTID = FACTCOFFEE.PRODUCTID
GROUP BY PRODCOFFEE.PRODNAME
ORDER BY sum(FACTCOFFEE.ACTPROFIT) DESC;

/* Monthly Colombia coffee sales in Yr 2012 */
SELECT extract(month from FACTCOFFEE.FACTDATE) as month, sum(FACTCOFFEE.ACTSALES)
FROM PRODCOFFEE, FACTCOFFEE, STATES, AREACODE
WHERE PRODCOFFEE.PRODUCTID = FACTCOFFEE.PRODUCTID AND FACTCOFFEE.AREAID = AREACODE.AREAID AND AREACODE.STATEID = STATES.STATEID
GROUP BY extract(year from FACTCOFFEE.FACTDATE),extract(month from FACTCOFFEE.FACTDATE),PRODCOFFEE.PRODNAME
HAVING extract(year from FACTCOFFEE.FACTDATE) = 2012 AND PRODCOFFEE.PRODNAME = 'Colombian'
ORDER BY sum(FACTCOFFEE.ACTSALES) DESC;

/* Add in quarters */
ALTER TABLE FACTCOFFEE
ADD QUARTER Char(2);
UPDATE FACTCOFFEE
SET QUARTER ='1'
WHERE TO_CHAR(FACTDATE,'MON')='JAN' OR TO_CHAR(FACTDATE,'MON')='FEB' OR TO_CHAR(FACTDATE,'MON')='MAR';
UPDATE FACTCOFFEE
SET QUARTER='2'
WHERE TO_CHAR(FACTDATE,'MON')='APR' OR TO_CHAR(FACTDATE,'MON')='MAY' OR TO_CHAR(FACTDATE,'MON')='JUN';
UPDATE FACTCOFFEE
SET QUARTER='3'
WHERE TO_CHAR(FACTDATE,'MON')='JUL' OR TO_CHAR(FACTDATE,'MON')='AUG' OR TO_CHAR(FACTDATE,'MON')='SEP';
UPDATE FACTCOFFEE
SET QUARTER='4'
WHERE TO_CHAR(FACTDATE,'MON')='OCT' OR TO_CHAR(FACTDATE,'MON')='NOV' OR TO_CHAR(FACTDATE,'MON')='DEC';

/* Quarterly Sales of coffee products in Yr 2012 and 2013 */
SELECT *
FROM(
SELECT PRODCOFFEE.PRODNAME,QUARTER, Sum(ActSales) SumSales,extract(year from factdate) AS YR
FROM factcoffee, prodcoffee
WHERE PRODCOFFEE.PRODUCTID = FACTCOFFEE.PRODUCTID AND extract(year from factdate) = 2013 OR extract(year from factdate) = 2012
GROUP BY PRODCOFFEE.PRODNAME,QUARTER,extract(year from factdate))
PIVOT (  
   Sum(SumSales)  
   FOR YR IN ('2012' as YR2012, '2013' as YR2013));

/* Create table with percentage of marginal profit among coffee products in various states */
CREATE TABLE Q8 AS(
SELECT *
FROM(
SELECT PRODCOFFEE.PRODNAME as prodname,STATES.STATENAME as statename,FACTCOFFEE.QUARTER as quarter,Sum(FACTCOFFEE.ACTSALES) SumSales,Sum(FACTCOFFEE.ACTPROFIT) SumProfit,Sum(FACTCOFFEE.ACTMARGIN) SumMargin,Sum(FACTCOFFEE.ACTMARKCOST) SumMarkcost,ROW_NUMBER() OVER(PARTITION BY FACTCOFFEE.QUARTER ORDER BY Sum(FACTCOFFEE.ACTSALES)) as myrank 
FROM PRODCOFFEE,STATES,FACTCOFFEE,AREACODE
WHERE FACTCOFFEE.AREAID = AREACODE.AREAID AND AREACODE.STATEID = STATES.STATEID AND PRODCOFFEE.PRODUCTID = FACTCOFFEE.PRODUCTID
GROUP BY PRODCOFFEE.PRODNAME,STATES.STATENAME,FACTCOFFEE.QUARTER));
ALTER TABLE Q8
ADD MarginPercent number;
UPDATE Q8
SET MarginPercent = ROUND(100*Q8.SUMMARGIN / 443038,4)

SELECT PRODNAME, STATENAME, sum(MARGINPERCENT)
FROM Q8
GROUP BY PRODNAME, STATENAME
ORDER BY sum(MARGINPERCENT) DESC;