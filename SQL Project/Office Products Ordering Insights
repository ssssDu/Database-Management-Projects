/* Create Office Products Tables */
CREATE Table MANAGERS (
REGID NUMBER PRIMARY KEY,
REGION  varchar2(10),
REGMANAGER  varchar2(10),
CONSTRAINT ch_REGION CHECK (REGION IN ('East', 'South', 'Central', 'West')));


CREATE Table PRODUCTS (
PRODID NUMBER PRIMARY KEY,
PRODNAME varchar2(100),
PRODCAT  varchar2(30),
PRODSUBCAT varchar2(30),
PRODCONT varchar2(20),
PRODUNITPRICE NUMBER(7,2),
PRODMARGIN NUMBER(5,3),
CONSTRAINT ch_PRODCAT CHECK (PRODCAT IN ('Technology', 'Furniture', 'Office Supplies')),
CONSTRAINT ch_PRODCONT CHECK(PRODCONT IN ('Jumbo Drum', 'Medium Box', 'Jumbo Box', 'Wrap Bag', 'Large Box', 'Small Box', 'Small Pack'
)));

CREATE Table ORDERS (
ORDERID NUMBER PRIMARY KEY,
STATUS varchar2(10));

CREATE Table CUSTOMERS (
CUSTID NUMBER PRIMARY KEY,
CUSTNAME varchar2(35),
CUSTREG  NUMBER(1,0),
CUSTSTATE varchar2(20),
CUSTCITY varchar2(20),
CUSTZIP NUMBER(5,0),
CUSTSEG VARCHAR2(15),
CONSTRAINT ch_CUSTSEG CHECK (CUSTSEG IN ('Home Office', 'Corporate', 'Small Business', 'Consumer')),
CONSTRAINT fk_CUSTREG FOREIGN KEY (CUSTREG) REFERENCES MANAGERS (REGID) on DELETE CASCADE);


CREATE Table ORDERDET (
ORDERID NUMBER,
CUSTID NUMBER,
PRODID NUMBER,
ORDPRIORITY VARCHAR2(15),
ORDDISCOUNT NUMBER(3,2),
ORDSHIPMODE VARCHAR2(15),
ORDDATE DATE,
ORDSHIPDATE DATE,
ORDSHIPCOST NUMBER(5,2),
ORDQTY NUMBER,
ORDSALES NUMBER(8,2),
CONSTRAINT ch_ORDPRIORITYY CHECK (ORDPRIORITY IN ('Low', 'Medium', 'High', 'Critical', 'Not Specified')),
CONSTRAINT ch_ORDSHIPMODEE CHECK (ORDSHIPMODE IN ('Regular Air','Delivery Truck','Express Air')),
CONSTRAINT pk_ORDERDET PRIMARY KEY (ORDERID, CUSTID,PRODID),
CONSTRAINT fk_ORDERIDC FOREIGN KEY (ORDERID) REFERENCES ORDERS (ORDERID),
CONSTRAINT fk_CUSTIDC FOREIGN KEY (CUSTID) REFERENCES CUSTOMERS (CUSTID),
CONSTRAINT fk_PRODIDC FOREIGN KEY (PRODID) REFERENCES PRODUCTS (PRODID));

/* Managers performance judging from ordersales */
SELECT M.REGMANAGER, sum(O.ORDSALES)
FROM ORDERDET O,MANAGERS M, CUSTOMERS C
WHERE M.REGID = C.CUSTREG AND C.CUSTID = O.CUSTID
GROUP BY M.REGMANAGER
ORDER BY sum(O.ORDSALES) DESC;

/* Products' average processing days abefore shipping */
SELECT E.PRODNAME,ROUND(E.shipday - E.ordday,2) as time
FROM(
SELECT avg(extract(day from O.ORDSHIPDATE)) as shipday,avg(extract(day from O.ORDDATE)) as ordday, P.PRODNAME
FROM PRODUCTS P,ORDERDET O
WHERE P.PRODUCTID = O.PRODID
GROUP BY P.PRODNAME) E
ORDER BY time DESC;

/* Ranking of the Sales of products in different cities */
SELECT C.CUSTCITY,P.PRODNAME, sum(O.ORDSALES) as SumSales, ROW_NUMBER()OVER(PARTITION BY C.CUSTCITY ORDER BY sum(O.ORDSALES)) as myrank
FROM CUSTOMERS C, ORDERDET O,PRODUCTS P
WHERE P.PRODUCTID = O.ORDERID AND O.CUSTID = C.CUSTID
GROUP BY C.CUSTCITY,P.PRODNAME
ORDER BY myrank ASC;

/* The Id of Top 5 customers with the most order sales in Yr 2013 */
SELECT C.CUSTID, sum(O.ORDSALES) as SumSales
FROM ORDERDET O, CUSTOMERS C
WHERE O.CUSTID = C.CUSTID AND extract(year from O.ORDDATE) = 2013
GROUP BY C.CUSTID, extract(year from O.ORDDATE)
ORDER BY SumSales DESC
FETCH FIRST 5 ROWS ONLY;

/* The Id of customers who have placed orders continously from 2012 to 2013 */
WITH Q6_1 AS(
SELECT extract(year from O.ORDDATE) as Yr, C.CUSTID, sum(O.ORDSALES) as SumSales
FROM ORDERDET O, CUSTOMERS C
WHERE O.CUSTID = C.CUSTID AND extract(year from O.ORDDATE) = 2013
GROUP BY C.CUSTID, extract(year from O.ORDDATE)
ORDER BY SumSales DESC),

Q6_2 AS(SELECT extract(year from O.ORDDATE) as Yr, C.CUSTID, sum(O.ORDSALES) as SumSales
FROM ORDERDET O, CUSTOMERS C
WHERE O.CUSTID = C.CUSTID AND extract(year from O.ORDDATE) = 2012
GROUP BY C.CUSTID, extract(year from O.ORDDATE)
ORDER BY SumSales DESC),

SELECT Q6_1.CUSTID
FROM Q6_1, Q6_2
WHERE Q6_1.CUSTID = Q6_2.CUSTID;


/* The Id of new customers in Yr 2013 */
WITH Q6_1 AS(
SELECT extract(year from O.ORDDATE) as Yr, C.CUSTID, sum(O.ORDSALES) as SumSales
FROM ORDERDET O, CUSTOMERS C
WHERE O.CUSTID = C.CUSTID AND extract(year from O.ORDDATE) = 2013
GROUP BY C.CUSTID, extract(year from O.ORDDATE)
ORDER BY SumSales DESC),

Q6_2 AS(SELECT extract(year from O.ORDDATE) as Yr, C.CUSTID, sum(O.ORDSALES) as SumSales
FROM ORDERDET O, CUSTOMERS C
WHERE O.CUSTID = C.CUSTID AND extract(year from O.ORDDATE) = 2012
GROUP BY C.CUSTID, extract(year from O.ORDDATE)
ORDER BY SumSales DESC),

Q6_3 AS(SELECT extract(year from O.ORDDATE) as Yr, C.CUSTID, sum(O.ORDSALES) as SumSales
FROM ORDERDET O, CUSTOMERS C
WHERE O.CUSTID = C.CUSTID AND extract(year from O.ORDDATE) = 2011
GROUP BY C.CUSTID, extract(year from O.ORDDATE)
ORDER BY SumSales DESC),

Q6_4 AS(SELECT extract(year from O.ORDDATE) as Yr, C.CUSTID, sum(O.ORDSALES) as SumSales
FROM ORDERDET O, CUSTOMERS C
WHERE O.CUSTID = C.CUSTID AND extract(year from O.ORDDATE) = 2010
GROUP BY C.CUSTID, extract(year from O.ORDDATE)
ORDER BY SumSales DESC)

SELECT CUSTID
FROM(
SELECT UNIQUE(Q6_1.CUSTID)
FROM Q6_1
MINUS
(SELECT UNIQUE(Q6_2.CUSTID)
FROM Q6_2
UNION
SELECT UNIQUE(Q6_3.CUSTID)
FROM Q6_3
UNION
SELECT UNIQUE(Q6_4.CUSTID)
FROM Q6_4));

/* Number of orders among various product subcategories in Michigan & Washington */
SELECT *
FROM(
SELECT C.CUSTSTATE, P.PRODSUBCAT, sum(O.ORDQTY) as SumQty
FROM ORDERDET O, PRODUCTS P,CUSTOMERS C
WHERE P.PRODUCTID = O.PRODID AND C.CUSTID = O.CUSTID 
GROUP BY C.CUSTSTATE, P.PRODSUBCAT
HAVING C.CUSTSTATE = 'Michigan' OR  C.CUSTSTATE = 'Washington')
PIVOT(
    sum(SumQty)
    FOR CUSTSTATE in ('Michigan' as MichiganQty, 'Washington' as WashingtonQty));


/* Order number in quarters */
SELECT to_char(O.ORDDATE,'Q') as quarter, sum(O.ORDQTY) as SumQty
FROM ORDERDET O
GROUP BY to_char(O.ORDDATE,'Q');

/* Order number in quarters among four customer regions */
SELECT to_char(O.ORDDATE,'Q') as quarter, C.CUSTREG, sum(O.ORDSALES) as SumSales
FROM ORDERDET O, CUSTOMERS C
WHERE O.CUSTID = C.CUSTID
GROUP BY C.CUSTREG,to_char(O.ORDDATE,'Q')
ORDER BY quarter, SumSales DESC;

